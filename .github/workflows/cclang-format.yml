name: Verifica√ß√£o de Formata√ß√£o C/C++

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  clang-format:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Instalar clang-format
      run: sudo apt-get update && sudo apt-get install -y clang-format

    - name: Criar .clang-format se n√£o existir
      run: |
        if [ ! -f ".clang-format" ]; then
          cat > .clang-format << EOF
BasedOnStyle: LLVM
IndentWidth: 4
UseTab: Never
EOF
        fi

    - name: Verificar formata√ß√£o
      run: |
        git fetch origin ${{ github.base_ref }}
        FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(c|h|cpp|hpp)$' || true)

        if [ -z "$FILES" ]; then
          echo "Nenhum ficheiro C/C++ alterado"
          exit 0
        fi

        echo "Ficheiros a verificar:"
        echo "$FILES"

        HAS_ISSUES=0
        echo "" > issues.txt

        for file in $FILES; do
          if [ -f "$file" ]; then
            echo "Verificando $file..."
            
            # Verifica formata√ß√£o sem alterar o arquivo
            if ! clang-format -style=file "$file" | diff -u "$file" - > "$file.diff"; then
              HAS_ISSUES=1
              echo "‚ùå $file tem problemas de formata√ß√£o"
              
              echo "### üìÑ \`$file\`" >> issues.txt
              echo "" >> issues.txt
              echo "<details><summary>Ver diferen√ßas</summary>" >> issues.txt
              echo "" >> issues.txt
              echo '```diff' >> issues.txt
              cat "$file.diff" >> issues.txt
              echo '```' >> issues.txt
              echo "</details>" >> issues.txt
              echo "" >> issues.txt
            else
              echo "‚úÖ $file est√° OK"
            fi

            rm -f "$file.diff"
          fi
        done

        if [ $HAS_ISSUES -eq 1 ]; then
          cat > comment.md << 'COMMENT'
## ‚ö†Ô∏è Problemas de Formata√ß√£o Detetados

Os seguintes ficheiros n√£o seguem o estilo de formata√ß√£o:

### Como corrigir:
```bash
# Instalar clang-format se necess√°rio
sudo apt-get install clang-format

# Corrigir automaticamente
clang-format -i *.c *.h
