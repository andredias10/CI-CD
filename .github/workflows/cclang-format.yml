name: Verifica√ß√£o de Formata√ß√£o C/C++

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.c'
      - '**.h'
      - '**.cpp'
      - '**.hpp'

permissions:
  contents: read
  pull-requests: write

jobs:
  clang-format-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha }}
    
    - name: Instalar clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format
        clang-format --version
    
    - name: Verificar formata√ß√£o e gerar sugest√µes
      id: format-check
      run: |
        set -e
        
        # Encontra todos os arquivos C/C++ modificados no PR
        echo "Base ref: ${{ github.event.pull_request.base.sha }}"
        echo "Head ref: ${{ github.event.pull_request.head.sha }}"
        
        FILES=$(git diff --name-only --diff-filter=ACMR ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -E '\.(c|h|cpp|hpp)$' || true)
        
        if [ -z "$FILES" ]; then
          echo "‚úÖ Nenhum arquivo C/C++ modificado no PR"
          echo "## ‚úÖ Formata√ß√£o OK" >> $GITHUB_STEP_SUMMARY
          echo "Nenhum arquivo C/C++ foi modificado neste PR." >> $GITHUB_STEP_SUMMARY
          exit 0
        fi
        
        echo "üìÅ Arquivos a verificar:"
        echo "$FILES"
        echo ""
        
        # Verifica se existe .clang-format
        if [ ! -f ".clang-format" ]; then
          echo "‚ö†Ô∏è Aviso: Ficheiro .clang-format n√£o encontrado. A usar estilo padr√£o LLVM."
          echo "BasedOnStyle: LLVM" > .clang-format
          echo "IndentWidth: 4" >> .clang-format
        fi
        
        # Verifica formata√ß√£o e gera relat√≥rio
        NEEDS_FORMAT=0
        
        # Cria arquivo de relat√≥rio
        echo "## üìù Sugest√µes de Formata√ß√£o" > format-report.md
        echo "" >> format-report.md
        
        for file in $FILES; do
          if [ -f "$file" ]; then
            echo "üîç Verificando: $file"
            
            # Cria arquivo tempor√°rio com c√≥digo formatado
            clang-format --style=file "$file" > "${file}.formatted"
            
            # Compara com original
            if ! cmp -s "$file" "${file}.formatted"; then
              NEEDS_FORMAT=1
              echo "‚ùå $file precisa de formata√ß√£o"
              
              # Adiciona ao relat√≥rio
              echo "### üìÑ \`${file}\`" >> format-report.md
              echo "" >> format-report.md
              echo "<details>" >> format-report.md
              echo "<summary>üîç Clica para ver as altera√ß√µes sugeridas</summary>" >> format-report.md
              echo "" >> format-report.md
              echo "\`\`\`diff" >> format-report.md
              diff -u "$file" "${file}.formatted" >> format-report.md || true
              echo "\`\`\`" >> format-report.md
              echo "</details>" >> format-report.md
              echo "" >> format-report.md
            else
              echo "‚úÖ $file est√° corretamente formatado"
            fi
            
            rm -f "${file}.formatted"
          else
            echo "‚ö†Ô∏è Ficheiro n√£o encontrado: $file (pode ter sido eliminado)"
          fi
        done
        
        echo ""
        
        if [ $NEEDS_FORMAT -eq 1 ]; then
          # Escreve no Summary
          echo "## ‚ö†Ô∏è Formata√ß√£o de C√≥digo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "O clang-format detetou problemas de formata√ß√£o no teu c√≥digo." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîß Como corrigir automaticamente:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Formatar ficheiros espec√≠ficos:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "clang-format -i caminho/do/ficheiro.c" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Formatar todos os ficheiros C/C++:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "find . -name '*.c' -o -name '*.h' -o -name '*.cpp' -o -name '*.hpp' | xargs clang-format -i" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Adiciona o relat√≥rio detalhado ao Summary
          cat format-report.md >> $GITHUB_STEP_SUMMARY
          
          echo "‚ùå Check falhou: ficheiros precisam de formata√ß√£o"
          exit 1
        else
          echo "## ‚úÖ Formata√ß√£o Correta" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Todos os ficheiros C/C++ est√£o corretamente formatados! üéâ" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Comentar no PR
      if: failure()
      run: |
        COMMENT_BODY=$(cat << 'EOF'
        ## ‚ö†Ô∏è Formata√ß√£o de C√≥digo
        
        O clang-format detetou problemas de formata√ß√£o no teu c√≥digo.
        
        ### üîß Como corrigir automaticamente:
        
        **Formatar ficheiros espec√≠ficos:**
        ```bash
        clang-format -i caminho/do/ficheiro.c
        ```
        
        **Formatar todos os ficheiros C/C++:**
        ```bash
        find . -name "*.c" -o -name "*.h" -o -name "*.cpp" -o -name "*.hpp" | xargs clang-format -i
        ```
        
        ---
        
        EOF
        )
        
        # Adiciona o conte√∫do do relat√≥rio
        if [ -f format-report.md ]; then
          COMMENT_BODY="${COMMENT_BODY}
$(cat format-report.md)"
        fi
        
        # Salva o coment√°rio num arquivo tempor√°rio
        echo "$COMMENT_BODY" > comment.md
        
        # Usa GitHub CLI para comentar
        gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md --edit-last || gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md
      env:
        GH_TOKEN: ${{ github.token }}
