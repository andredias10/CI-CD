name: Verifica√ß√£o de Formata√ß√£o C/C++

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  clang-format:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Instalar clang-format
      run: sudo apt-get update && sudo apt-get install -y clang-format
    
    - name: Verificar formata√ß√£o
      run: |
        # Criar .clang-format se n√£o existir
        if [ ! -f ".clang-format" ]; then
          cat > .clang-format << EOF
        BasedOnStyle: LLVM
        IndentWidth: 4
        UseTab: Never
        EOF
        fi
        
        # Encontrar ficheiros alterados
        git fetch origin ${{ github.base_ref }}
        FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(c|h|cpp|hpp)$' || true)
        
        if [ -z "$FILES" ]; then
          echo "Nenhum ficheiro C/C++ alterado"
          exit 0
        fi
        
        echo "Ficheiros a verificar:"
        echo "$FILES"
        
        # Verificar cada ficheiro
        HAS_ISSUES=0
        echo "" > issues.txt
        
        for file in $FILES; do
          if [ -f "$file" ]; then
            echo "Verificando $file..."
            
            # Formatar e comparar
            clang-format "$file" > "$file.fmt"
            
            if ! diff -u "$file" "$file.fmt" > "$file.diff"; then
              HAS_ISSUES=1
              echo "‚ùå $file tem problemas de formata√ß√£o"
              
              echo "### üìÑ \`$file\`" >> issues.txt
              echo "" >> issues.txt
              echo "<details><summary>Ver diferen√ßas</summary>" >> issues.txt
              echo "" >> issues.txt
              echo '```diff' >> issues.txt
              cat "$file.diff" >> issues.txt
              echo '```' >> issues.txt
              echo "</details>" >> issues.txt
              echo "" >> issues.txt
            else
              echo "‚úÖ $file est√° OK"
            fi
            
            rm -f "$file.fmt" "$file.diff"
          fi
        done
        
        # Criar coment√°rio se houver problemas
        if [ $HAS_ISSUES -eq 1 ]; then
          # Listar ficheiros com problemas para o comando
          PROBLEM_FILES=$(echo "$FILES" | tr '\n' ' ')
          
          cat > comment.md << EOF
        ## ‚ö†Ô∏è Problemas de Formata√ß√£o Detetados
        
        Os seguintes ficheiros n√£o seguem o estilo de formata√ß√£o:
        
        ### Como corrigir:
        
        **Op√ß√£o 1 - Corrigir ficheiros espec√≠ficos:**
        \`\`\`bash
        clang-format -i $PROBLEM_FILES
        \`\`\`
        
        **Op√ß√£o 2 - Corrigir todos os ficheiros C/C++ do projeto:**
        \`\`\`bash
        find . -type f \( -name "*.c" -o -name "*.h" -o -name "*.cpp" -o -name "*.hpp" \) -exec clang-format -i {} +
        \`\`\`
        
        **Op√ß√£o 3 - Corrigir apenas ficheiros alterados neste PR:**
        \`\`\`bash
        git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(c|h|cpp|hpp)
          
          # Comentar usando gh cli
          gh pr comment ${{ github.event.number }} \
            --body-file comment.md \
            --edit-last 2>/dev/null || gh pr comment ${{ github.event.number }} --body-file comment.md
          
          echo "‚ùå Formata√ß√£o incorreta"
          exit 1
        fi
        
        echo "‚úÖ Todos os ficheiros est√£o bem formatados"
      env:
        GH_TOKEN: ${{ github.token }}
 | xargs clang-format -i
        \`\`\`
        
        ---
        
        EOF
          
          cat issues.txt >> comment.md
          
          # Comentar usando gh cli
          gh pr comment ${{ github.event.number }} \
            --body-file comment.md \
            --edit-last 2>/dev/null || gh pr comment ${{ github.event.number }} --body-file comment.md
          
          echo "‚ùå Formata√ß√£o incorreta"
          exit 1
        fi
        
        echo "‚úÖ Todos os ficheiros est√£o bem formatados"
      env:
        GH_TOKEN: ${{ github.token }}
