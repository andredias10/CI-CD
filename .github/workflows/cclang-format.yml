name: C/C++ Format Check

on:
  pull_request:
    paths:
      - '**/*.c'
      - '**/*.cpp'
      - '**/*.h'
      - '**/*.hpp'

jobs:
  format-check:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout do código
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2️⃣ Instalar clang-format
      - name: Install clang-format
        run: |
          sudo apt update
          sudo apt install -y clang-format

      # 3️⃣ Instalar reviewdog (binário)
      - name: Install reviewdog
        run: |
          curl -sfL https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh | sh -s -- -b /usr/local/bin

      # 4️⃣ Rodar clang-format + reviewdog
      - name: Run clang-format with reviewdog
        run: |
          FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- '*.c' '*.cpp' '*.h' '*.hpp')
          if [ -n "$FILES" ]; then
            for f in $FILES; do
              clang-format -style=file "$f" | reviewdog \
                -f=diff \
                -name="clang-format" \
                -reporter=github-pr-review \
                -level=warning
            done
          else
            echo "No C/C++ files changed."
          fi
        shell: bash
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
