name: Verifica√ß√£o de Formata√ß√£o C/C++

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.c'
      - '**.h'
      - '**.cpp'
      - '**.hpp'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  clang-format-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Instalar clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format
    
    - name: Verificar formata√ß√£o
      id: format-check
      run: |
        # Encontra todos os arquivos C/C++ modificados no PR
        FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(c|h|cpp|hpp)$' || true)
        
        if [ -z "$FILES" ]; then
          echo "Nenhum arquivo C/C++ modificado"
          exit 0
        fi
        
        echo "Arquivos a verificar:"
        echo "$FILES"
        
        # Verifica formata√ß√£o
        NEEDS_FORMAT=0
        for file in $FILES; do
          if [ -f "$file" ]; then
            clang-format --style=file --dry-run --Werror "$file" 2>&1 || NEEDS_FORMAT=1
          fi
        done
        
        if [ $NEEDS_FORMAT -eq 1 ]; then
          echo "‚ùå Alguns arquivos precisam de formata√ß√£o"
          echo "needs_format=true" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "‚úÖ Todos os arquivos est√£o corretamente formatados"
          echo "needs_format=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Gerar diff de formata√ß√£o
      if: failure()
      run: |
        echo "## üìù Sugest√µes de Formata√ß√£o" > format-suggestions.md
        echo "" >> format-suggestions.md
        
        FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(c|h|cpp|hpp)
    
    - name: Comentar no PR com sugest√µes
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let comment = '## ‚ö†Ô∏è Formata√ß√£o de C√≥digo\n\n';
          comment += 'O clang-format detetou problemas de formata√ß√£o no teu c√≥digo.\n\n';
          comment += '### üîß Como corrigir automaticamente:\n\n';
          comment += '**Op√ß√£o 1 - Formatar ficheiros espec√≠ficos:**\n';
          comment += '```bash\n';
          comment += 'clang-format -i caminho/do/ficheiro.c\n';
          comment += '```\n\n';
          comment += '**Op√ß√£o 2 - Formatar todos os ficheiros C/C++:**\n';
          comment += '```bash\n';
          comment += 'find . -name "*.c" -o -name "*.h" -o -name "*.cpp" -o -name "*.hpp" | xargs clang-format -i\n';
          comment += '```\n\n';
          comment += '---\n\n';
          
          if (fs.existsSync('format-suggestions.md')) {
            const suggestions = fs.readFileSync('format-suggestions.md', 'utf8');
            comment += suggestions;
          } else {
            comment += '_N√£o foi poss√≠vel gerar o diff das altera√ß√µes._\n';
          }
          
          // Procura coment√°rio anterior do bot
          const {data: comments} = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('‚ö†Ô∏è Formata√ß√£o de C√≥digo')
          );
          
          if (botComment) {
            // Atualiza coment√°rio existente
            await github.rest.issues.updateComment({
              comment_id: botComment.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } else {
            // Cria novo coment√°rio
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }
 || true)
        
        for file in $FILES; do
          if [ -f "$file" ]; then
            echo "### üìÑ \`$file\`" >> format-suggestions.md
            echo "" >> format-suggestions.md
            
            # Gera o diff
            DIFF_OUTPUT=$(diff -u "$file" <(clang-format --style=file "$file") || true)
            
            if [ -n "$DIFF_OUTPUT" ]; then
              echo '<details>' >> format-suggestions.md
              echo '<summary>Ver altera√ß√µes sugeridas</summary>' >> format-suggestions.md
              echo "" >> format-suggestions.md
              echo "\`\`\`diff" >> format-suggestions.md
              echo "$DIFF_OUTPUT" >> format-suggestions.md
              echo "\`\`\`" >> format-suggestions.md
              echo '</details>' >> format-suggestions.md
              echo "" >> format-suggestions.md
            fi
          fi
        done
    
    - name: Comentar no PR com sugest√µes
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let comment = '## ‚ö†Ô∏è Formata√ß√£o de C√≥digo\n\n';
          comment += 'O clang-format detectou problemas de formata√ß√£o no seu c√≥digo.\n\n';
          comment += '### Como corrigir:\n\n';
          comment += '```bash\n';
          comment += '# Formatar todos os arquivos C/C++\n';
          comment += 'clang-format -i **/*.{c,h,cpp,hpp}\n';
          comment += '```\n\n';
          
          if (fs.existsSync('format-suggestions.md')) {
            const suggestions = fs.readFileSync('format-suggestions.md', 'utf8');
            comment += suggestions;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
