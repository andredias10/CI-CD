name: C/C++ Format Check

on:
  pull_request:
    paths:
      - '**/*.c'
      - '**/*.cpp'
      - '**/*.h'
      - '**/*.hpp'

jobs:
  clang-format-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install clang-format
        run: |
          sudo apt update
          sudo apt install -y clang-format

      - name: Setup reviewdog
        uses: reviewdog/action-setup@v1
        with:
          version: latest

      - name: Run clang-format-diff and reviewdog
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1

          # Get list of changed files in PR
          git diff origin/${{ github.base_ref }} -- '*.c' '*.cpp' '*.h' '*.hpp' > pr.diff || true

          # Generate clang-format patch for changed lines
          python3 - <<'EOF'
import subprocess
import sys

with open('pr.diff', 'r') as f:
    diff = f.read()

p = subprocess.Popen(
    ['clang-format-diff.py', '-p1', '-style=file'],
    stdin=subprocess.PIPE,
    stdout=subprocess.PIPE,
    stderr=subprocess.PIPE,
    text=True
)
out, err = p.communicate(input=diff)
if out:
    with open('clang_diff.patch', 'w') as f:
        f.write(out)
EOF

          # Post suggestions using reviewdog
          if [ -s clang_diff.patch ]; then
            cat clang_diff.patch | reviewdog -f=diff -name="clang-format" -reporter=github-pr-review -level=warning
          else
            echo "âœ” All changed files are properly formatted!"
          fi
