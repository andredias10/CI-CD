name: Verifica√ß√£o de Formata√ß√£o C/C++

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.c'
      - '**.h'
      - '**.cpp'
      - '**.hpp'

permissions:
  contents: read
  pull-requests: write

jobs:
  clang-format-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Instalar clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format
    
    - name: Verificar formata√ß√£o e gerar sugest√µes
      id: format-check
      run: |
        # Encontra todos os arquivos C/C++ modificados no PR
        FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(c|h|cpp|hpp)
    
    - name: Comentar no PR
      if: failure()
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: clang-format
        recreate: true
        message: |
          ## ‚ö†Ô∏è Formata√ß√£o de C√≥digo
          
          O clang-format detetou problemas de formata√ß√£o no teu c√≥digo.
          
          ### üîß Como corrigir automaticamente:
          
          **Formatar ficheiros espec√≠ficos:**
          ```bash
          clang-format -i caminho/do/ficheiro.c
          ```
          
          **Formatar todos os ficheiros C/C++:**
          ```bash
          find . -name "*.c" -o -name "*.h" -o -name "*.cpp" -o -name "*.hpp" | xargs clang-format -i
          ```
          
          ---
          
          $(cat format-report.md 2>/dev/null || echo "V√™ o **Job Summary** para detalhes das altera√ß√µes.")
 || true)
        
        if [ -z "$FILES" ]; then
          echo "‚úÖ Nenhum arquivo C/C++ modificado"
          exit 0
        fi
        
        echo "üìÅ Arquivos a verificar:"
        echo "$FILES"
        echo ""
        
        # Verifica formata√ß√£o e gera relat√≥rio
        NEEDS_FORMAT=0
        
        # Cria arquivo de relat√≥rio
        echo "## üìù Sugest√µes de Formata√ß√£o" > format-report.md
        echo "" >> format-report.md
        
        for file in $FILES; do
          if [ -f "$file" ]; then
            echo "Verificando: $file"
            
            # Cria arquivo tempor√°rio com c√≥digo formatado
            clang-format --style=file "$file" > "${file}.formatted"
            
            # Compara com original
            if ! diff -q "$file" "${file}.formatted" > /dev/null 2>&1; then
              NEEDS_FORMAT=1
              echo "‚ùå $file precisa de formata√ß√£o"
              
              # Adiciona ao relat√≥rio
              echo "### üìÑ \`${file}\`" >> format-report.md
              echo "" >> format-report.md
              echo "<details>" >> format-report.md
              echo "<summary>Ver altera√ß√µes sugeridas</summary>" >> format-report.md
              echo "" >> format-report.md
              echo "\`\`\`diff" >> format-report.md
              diff -u "$file" "${file}.formatted" >> format-report.md || true
              echo "\`\`\`" >> format-report.md
              echo "</details>" >> format-report.md
              echo "" >> format-report.md
            else
              echo "‚úÖ $file est√° corretamente formatado"
            fi
            
            rm -f "${file}.formatted"
          fi
        done
        
        echo ""
        
        if [ $NEEDS_FORMAT -eq 1 ]; then
          # Escreve no Summary
          echo "## ‚ö†Ô∏è Formata√ß√£o de C√≥digo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "O clang-format detetou problemas de formata√ß√£o no teu c√≥digo." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîß Como corrigir automaticamente:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Formatar ficheiros espec√≠ficos:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "clang-format -i caminho/do/ficheiro.c" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Formatar todos os ficheiros C/C++:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "find . -name '*.c' -o -name '*.h' -o -name '*.cpp' -o -name '*.hpp' | xargs clang-format -i" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Adiciona o relat√≥rio detalhado ao Summary
          cat format-report.md >> $GITHUB_STEP_SUMMARY
          
          exit 1
        else
          echo "‚úÖ Todos os arquivos est√£o corretamente formatados" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Ler relat√≥rio
      if: failure()
      id: read-report
      run: |
        if [ -f format-report.md ]; then
          CONTENT=$(cat format-report.md)
          # Escapa caracteres especiais para usar no GitHub Actions
          CONTENT="${CONTENT//'%'/'%25'}"
          CONTENT="${CONTENT//
    
    - name: Comentar no PR
      if: failure()
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: clang-format
        message: |
          ## ‚ö†Ô∏è Formata√ß√£o de C√≥digo
          
          O clang-format detetou problemas de formata√ß√£o no teu c√≥digo.
          
          ### üîß Como corrigir automaticamente:
          
          **Formatar ficheiros espec√≠ficos:**
          ```bash
          clang-format -i caminho/do/ficheiro.c
          ```
          
          **Formatar todos os ficheiros C/C++:**
          ```bash
          find . -name "*.c" -o -name "*.h" -o -name "*.cpp" -o -name "*.hpp" | xargs clang-format -i
          ```
          
          ---
          
          ## üìù Sugest√µes de Formata√ß√£o
          
          ${{ steps.format-check.outputs.report }}
          
          <details>
          <summary>üí° Ver diff completo no Job Summary</summary>
          
          Clica no link do workflow acima para ver as altera√ß√µes detalhadas no "Summary" do job.
          </details>
\n'/'%0A'}"
          CONTENT="${CONTENT//
    
    - name: Comentar no PR
      if: failure()
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: clang-format
        message: |
          ## ‚ö†Ô∏è Formata√ß√£o de C√≥digo
          
          O clang-format detetou problemas de formata√ß√£o no teu c√≥digo.
          
          ### üîß Como corrigir automaticamente:
          
          **Formatar ficheiros espec√≠ficos:**
          ```bash
          clang-format -i caminho/do/ficheiro.c
          ```
          
          **Formatar todos os ficheiros C/C++:**
          ```bash
          find . -name "*.c" -o -name "*.h" -o -name "*.cpp" -o -name "*.hpp" | xargs clang-format -i
          ```
          
          ---
          
          ## üìù Sugest√µes de Formata√ß√£o
          
          ${{ steps.format-check.outputs.report }}
          
          <details>
          <summary>üí° Ver diff completo no Job Summary</summary>
          
          Clica no link do workflow acima para ver as altera√ß√µes detalhadas no "Summary" do job.
          </details>
\r'/'%0D'}"
          echo "content=$CONTENT" >> $GITHUB_OUTPUT
        else
          echo "content=N√£o foi poss√≠vel gerar o relat√≥rio." >> $GITHUB_OUTPUT
        fi
    
    - name: Comentar no PR
      if: failure()
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: clang-format
        message: |
          ## ‚ö†Ô∏è Formata√ß√£o de C√≥digo
          
          O clang-format detetou problemas de formata√ß√£o no teu c√≥digo.
          
          ### üîß Como corrigir automaticamente:
          
          **Formatar ficheiros espec√≠ficos:**
          ```bash
          clang-format -i caminho/do/ficheiro.c
          ```
          
          **Formatar todos os ficheiros C/C++:**
          ```bash
          find . -name "*.c" -o -name "*.h" -o -name "*.cpp" -o -name "*.hpp" | xargs clang-format -i
          ```
          
          ---
          
          ## üìù Sugest√µes de Formata√ß√£o
          
          ${{ steps.format-check.outputs.report }}
          
          <details>
          <summary>üí° Ver diff completo no Job Summary</summary>
          
          Clica no link do workflow acima para ver as altera√ß√µes detalhadas no "Summary" do job.
          </details>
